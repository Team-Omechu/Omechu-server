# .github/workflows/deploy.yml
name: Deploy FoodApp to EC2

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - 'PULL_REQUEST_TEMPLATE.md'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'backend/package-lock.json'
    
    - name: Check backend structure
      run: |
        echo "Backend directory structure:"
        ls -la backend/ || echo "No backend directory found"
        
        echo "Package files:"
        ls -la backend/package*.json || echo "No package files found in backend/"
        
        echo "Root directory:"
        ls -la package*.json || echo "No package files found in root"
    
    - name: Install backend dependencies
      working-directory: ./backend
      run: |
        if [ -f "package.json" ]; then
          echo "Installing dependencies from backend/package.json"
          npm install
        else
          echo "No package.json found in backend directory"
          exit 1
        fi
    
    - name: Run backend tests
      working-directory: ./backend
      run: npm test || echo "No tests defined yet - continuing deployment"
    
    - name: Run linter
      working-directory: ./backend
      run: npm run lint || echo "No linter configured yet - continuing deployment"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    name: Deploy to EC2
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Deploy to EC2 via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        timeout: 300s
        script: |
          # ë³€ìˆ˜ ì„¤ì •
          PROJECT_DIR="/home/ubuntu/foodapp"
          LOG_FILE="/home/ubuntu/deploy.log"
          
          # ë¡œê·¸ í•¨ìˆ˜
          log() {
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
          }
          
          log "ğŸš€ Starting deployment process..."
          
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd $PROJECT_DIR || {
              log "âŒ Failed to change directory to $PROJECT_DIR"
              exit 1
          }
          
          # í˜„ì¬ ì»¤ë°‹ ì •ë³´ ì €ì¥
          CURRENT_COMMIT=$(git rev-parse --short HEAD)
          log "ğŸ“ Current commit: $CURRENT_COMMIT"
          
          # Git ì—…ë°ì´íŠ¸
          log "ğŸ“¥ Pulling latest changes..."
          git fetch origin
          git reset --hard origin/main
          
          NEW_COMMIT=$(git rev-parse --short HEAD)
          log "ğŸ“ New commit: $NEW_COMMIT"
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì¬ë°°í¬
          if [ "$CURRENT_COMMIT" != "$NEW_COMMIT" ]; then
              log "ğŸ”„ Changes detected, proceeding with deployment..."
              
              # Backend ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ (ì¡°ê±´ë¶€)
              if [ -d "backend" ] && [ -f "backend/package.json" ]; then
                  log "ğŸ“¦ Installing backend dependencies..."
                  cd backend
                  npm install --production
                  cd ..
              else
                  log "â„¹ï¸  No backend directory or package.json found, skipping npm install"
              fi
              
              # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
              log "ğŸŒ Setting up environment variables..."
              if [ -f .env.production ]; then
                  cp .env.production .env
              fi
              
              # Docker ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
              log "ğŸ³ Restarting Docker containers..."
              docker-compose down
              docker-compose up -d --build
              
              # ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸°
              log "â³ Waiting for services to start..."
              sleep 30
              
              # í—¬ìŠ¤ ì²´í¬
              log "ğŸ¥ Performing health check..."
              HEALTH_CHECK_PASSED=false
              
              for i in {1..10}; do
                  if curl -f http://localhost:3000/health > /dev/null 2>&1; then
                      log "âœ… Backend health check passed"
                      HEALTH_CHECK_PASSED=true
                      break
                  elif curl -f http://localhost:3000/ > /dev/null 2>&1; then
                      log "âœ… Backend is responding"
                      HEALTH_CHECK_PASSED=true
                      break
                  fi
                  log "â³ Health check attempt $i/10 failed, retrying..."
                  sleep 10
              done
              
              # Nginx ì²´í¬
              if curl -f http://localhost/ > /dev/null 2>&1; then
                  log "âœ… Nginx is responding"
              else
                  log "âš ï¸  Nginx health check failed"
              fi
              
              if [ "$HEALTH_CHECK_PASSED" = true ]; then
                  log "ğŸ‰ Deployment completed successfully!"
                  log "ğŸ“Š Container status:"
                  docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
                  
                  # ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬
                  log "ğŸ§¹ Cleaning up old Docker images..."
                  docker image prune -f
                  
              else
                  log "âŒ Deployment failed - health check did not pass"
                  log "ğŸ“‹ Container logs:"
                  docker-compose logs --tail=50
                  exit 1
              fi
              
          else
              log "â„¹ï¸  No changes detected, skipping deployment"
          fi
          
          log "âœ¨ Deployment process completed"

  notify:
    needs: [test, deploy]
    runs-on: ubuntu-latest
    name: Send Notification
    if: always()
    
    steps:
    - name: Log deployment result
      run: |
        echo "Deployment Status: ${{ needs.deploy.result }}"
        echo "Test Status: ${{ needs.test.result }}"
